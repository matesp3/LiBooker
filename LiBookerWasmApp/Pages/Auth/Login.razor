@page "/login"
@using LiBookerWasmApp.Services.Auth
@inject CustomAuthStateProvider AuthProvider
@inject NavigationManager Navigation

<PageTitle>LiBooker - Login</PageTitle>

<div class="auth-wrapper fade-in">
    <div class="auth-card">
        
        <!-- Header with Icon -->
        <div class="auth-header text-center">
            <div class="icon-circle">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
                    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
                </svg>
            </div>
            <h3>Welcome Back</h3>
            <p class="text-muted">Sign in to your account</p>
        </div>

        @if (!string.IsNullOrEmpty(this.ErrorMessage))
        {
            <div class="alert alert-danger text-center">
                <i class="bi bi-exclamation-circle me-2"></i> @this.ErrorMessage
            </div>
        }
        
        @if (!string.IsNullOrEmpty(this.InfoMessage))
        {
            <div class="alert alert-success text-center">
                <i class="bi bi-info-circle me-2"></i> @this.InfoMessage
            </div>
        }

        <EditForm Model="@this.LoginModel" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            
            <div class="form-group mb-4">
                <label class="form-label">Email</label>
                <InputText @bind-Value="this.LoginModel.Email" class="form-control" placeholder="name@example.com" />
                <ValidationMessage For="@(() => this.LoginModel.Email)" />
            </div>

            <div class="form-group mb-4">
                <label class="form-label">Password</label>
                <InputText @bind-Value="this.LoginModel.Password" type="password" class="form-control" placeholder="••••••••" />
                <ValidationMessage For="@(() => this.LoginModel.Password)" />
            </div>

            <button type="submit" class="btn btn-auth w-100 mb-3" disabled="@this.IsProcessing">
                @if (this.IsProcessing)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Signing in...</span>
                }
                else
                {
                    <span>Sign in</span>
                }
            </button>
        </EditForm>
        
        <div class="auth-footer text-center">
            <small>Don't have an account? <a href="register" class="auth-link">Create one</a></small>
        </div>
    </div>
</div>

@code {
    // automatic linking of query parameter ?loggedOut=true
    [SupplyParameterFromQuery]
    public bool LoggedOut { get; set; } = false;
    // automatic linking of query parameter ?registeredNow=true
    [SupplyParameterFromQuery]
    public bool RegisteredNow { get; set; } = false;

    private LiBooker.Shared.DTOs.Login LoginModel = new();
    private string? ErrorMessage;
    private string? InfoMessage;
    private bool IsProcessing = false;

    protected override void OnInitialized()
    {
        if (this.LoggedOut)
        {
            this.InfoMessage = "You have been successfully logged out.";
        }
        else if (this.RegisteredNow)
        {
            this.InfoMessage = "Registration successful! Please log in with your new account.";
        }
    }

    private async Task HandleLogin()
    {
        this.IsProcessing = true;
        this.ErrorMessage = null;
        this.InfoMessage = null;

        try
        {
            var success = await this.AuthProvider.LoginAsync(this.LoginModel);
            if (success)
            {
                this.Navigation.NavigateTo("/");
            }
            else
            {
                this.ErrorMessage = "Invalid email or password.";
            }
        }
        catch (Exception ex)
        {
            this.ErrorMessage = $"Connection error: {ex.Message}";
        }
        finally
        {
            this.IsProcessing = false;
        }
    }
}