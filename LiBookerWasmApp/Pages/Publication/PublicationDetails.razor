@page "/publications/{publicationId:int}"
@page "/publication/{publicationId:int}"
@using LiBooker.Shared.DTOs
@using LiBooker.Shared.Roles
@using LiBookerWasmApp.Pages.Publication.Components

<div class="publication-detail-container">
    @if (this.IsLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(this.error) || this.details is null)
    {
        <div class="alert alert-danger shadow-sm border-0">
            @(this.error ?? "Publication details not available.")
        </div>
    }
    else
    {
        <div class="row g-5">
            <!-- Left Column: Image -->
            <div class="col-lg-5">
                <div class="image-box">
                    @{

                        var imgUrl = Converter.GetImageDataUrl(this.rawPicture);
                    }
                    @if (!string.IsNullOrEmpty(imgUrl))
                    {
                        <img src="@imgUrl" class="img-fluid" alt="@this.details.BookTitle" />
                    }
                    else
                    {
                        <div class="image-placeholder">
                            <i class="bi bi-image" style="font-size: 2rem; display: block; margin-bottom: 10px;"></i>
                            <span>Picture not available</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Right Column: Info -->
            <div class="col-lg-7 d-flex flex-column">
                <!-- Main Info Card -->
                <div class="unified-card mb-4">
                    <h1 class="pub-title">@this.details.BookTitle</h1>
                    <p class="pub-authors">
                        <span class="label">authors:</span> @this.details.AuthorFullNames
                    </p>

                    <div class="pub-description mt-4">
                        <p>@(this.BookDescription)</p>
                    </div>
                </div>

                <div class="row g-4 flex-grow-1">
                    <!-- Details Box (Now on Left) -->
                    <div class="col-md-6">
                        <div class="unified-card">
                            <h5 class="info-card-title">Details</h5>
                            <div class="details-content">
                                <p><strong>Publisher:</strong><br /> @this.details.PublisherName</p>
                                <p><strong>Genres:</strong><br /> @this.details.GenreNames</p>
                                <p><strong>Year:</strong> @this.details.PublicationYear</p>
                                <div style="margin-top: 1rem; border-top: 1px dashed #dee2e6; padding-top: 0.5rem;">
                                    <p class="mb-1 text-muted"><small>Format Info:</small></p>
                                    <p class="mb-0">Pages: @(this.details.PageCount) | ISBN: @(this.details.Isbn)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Parameters Box (Now on Right) -->
                    <div class="col-md-6">
                        <div class="unified-card">
                            <h5 class="info-card-title">Parameters</h5>
                            <ul class="info-list">
                                <li><span>Binding</span> <strong>@(this.details.Binding)</strong></li>
                                <li><span>Paper</span> <strong>@(this.details.Paper)</strong></li>
                                <li><span>Cover</span> <strong>@(this.details.Cover)</strong></li>
                                <li><span>Dimensions</span> <strong>@(this.details.Dimensions)</strong></li>
                                <li><span>Weight</span> <strong>@(this.details.Weight)</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons Area -->
                <div class="action-area d-flex gap-3 align-items-center">
                    @if (this.IsPublicationAvailable)
                    {
                        <div class="badge-status status-available">
                            Available
                        </div>

                        <AuthorizeView Roles="@($"{UserRolesExtensions.GetRoleName(UserRoles.Admin)}, {UserRolesExtensions.GetRoleName(UserRoles.Librarian)}")">
                            <Authorized>
                                <button class="btn btn-reserve" @onclick="OpenReserveModal">RESERVE</button>
                            </Authorized>
                            <NotAuthorized>
                                <button class="btn btn-reserve" disabled>RESERVE</button>
                            </NotAuthorized>
                        </AuthorizeView>
                    }
                    else
                    {
                        <div class="badge-status status-unavailable">
                            Unavailable
                        </div>
                        <button class="btn btn-reserve" disabled>
                            RESERVE
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@* Modal Component Instance (unchanged) *@
<AddReservationModal Publication="@publication"
                     @bind-IsOpen="isReserveModalOpen"
                     OnReservationSuccess="OnReservationCreated" />
