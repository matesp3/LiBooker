@page "/"
@page "/publications"

<div class="page-header mb-4">
    <h1 class="display-6 fw-bold text-brand">Explore Publications</h1>
    <p class="text-muted">Browse through our extensive library collection</p>
</div>

<!-- Filters section -->
<div class="filters-container fade-in">
   <div class="filters-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"/>
        </svg>
        <span>Filters & Sort</span>
    </div>
    
    <div class="filters-row align-items-center">
        @if (!string.IsNullOrEmpty(this.SelectedType) && !string.IsNullOrEmpty(this.SelectedName))
        {
            <div class="me-3">
                <span class="badge rounded-pill bg-secondary d-flex align-items-center p-2 px-3 shadow-sm">
                    <span class="me-2 text-uppercase fw-light" style="font-size: 0.75rem; opacity: 0.8;">
                        Filter @(this.SelectedType):
                    </span>
                    <span class="fw-bold me-2">
                        @this.SelectedName
                    </span>
                    <button type="button" class="btn-close btn-close-white" style="width: 0.5em; height: 0.5em;" 
                            aria-label="Remove filter" 
                            @onclick="ClearActiveFilter"></button>
                </span>
            </div>
        }
        
        <div class="filter-group">
            <label class="filter-label">Availability</label>
            <select class="form-select custom-select" @bind="this.filterAvailability" @bind:after="OnFilterChanged">
                <option value="@(PublicationParams.GetAvailabilityText(PublicationParams.PublicationAvailability.All))">All</option>
                <option value="@(PublicationParams.GetAvailabilityText(PublicationParams.PublicationAvailability.AvailableOnly))">Available</option>
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">Sort by</label>
            <select class="form-select custom-select" @bind="this.filterSort" @bind:after="OnFilterChanged">
                <option value="@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.None))">None</option>
                <option value="@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByTitleAsc))">Name (A-Z)</option>
                <option value="@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByTitleDesc))">Name (Z-A)</option>
                <option value="@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByPublicationYearAsc))">Year (Oldest first)</option>
                <option value="@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByPublicationYearDesc))">Year (Newest first)</option>
                <option value="@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByGreatestPopularity))">Most Popular</option>
            </select>
        </div>
    </div>
</div>

@if (this.isLoading)
{
    <p><em>Loading publications...</em></p>
}
else if (!string.IsNullOrEmpty(this.error))
{
    <div class="alert alert-danger">@error</div>
}
else if (this.publications is null || this.publications.Count == 0)
{
    <p>No publications found.</p>
}
else
{
    @if (this.isLoadingImages)
    {
        <div class="alert alert-info image-loading-badge">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>Loading images...</span>
        </div>
    }

    <div class="row g-4">
        @for (int idx = 0; idx < this.publications.Count; idx++)
        {
            var pub = this.publications[idx];
            <div class="col-md-4 col-sm-6">
                <!-- Added onclick event here to the card -->
                <div class="card h-100" @onclick="() => NavigateToDetails((idx+1))">
                    
                    <div class="publication-image-container">
                        @* Availability Badge *@
                        @if (pub.IsAvailable)
                        {
                            <span class="availability-badge badge-available">Available</span>
                        }
                        else
                        {
                            <span class="availability-badge badge-unavailable">Unavailable</span>
                        }

                        @{
                            var imageUrl = GetImageDataUrl(pub?.Image);
                        }
                        
                        @* Image loading logic ... *@
                        @if (!string.IsNullOrEmpty(imageUrl))
                        {
                            <img src="@imageUrl" class="publication-image" alt="@(pub?.Title ?? "Unknown title")" />
                        }
                        else if (this.isLoadingImages && idx >= this.imagesLoaded)
                        {
                            <div class="publication-image-placeholder">
                                <span>Loading...</span>
                            </div>
                        }
                        else
                        {
                            <div class="publication-image-placeholder">
                                <!-- SVG Icon placeholder ... -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
                                    <path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2zM14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1zM2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1h-10z"/>
                                </svg>
                                <span class="mt-2">No image</span>
                            </div>
                        }
                    </div>

                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@(pub?.Title ?? "Unknown title")</h5>
                        <p class="card-text flex-grow-1">
                            <strong>Author:</strong> @(pub?.Author ?? "Unknown author")<br/>
                            <strong>Publisher:</strong> @(pub?.Publication ?? "Unknown publication")<br/>
                            <strong>Year:</strong> @(pub?.Year.ToString() ?? "Unknown publication year")
                        </p>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="pagination-container">
        <button class="btn btn-theme me-1" @onclick="FirstPage" disabled="@(this.currentPage <= 1 || this.isLoading)" 
                title="First Page" style="padding: 0 10px; min-width: 40px;">
            <span>&laquo;</span>
        </button>

        <button class="btn btn-theme" @onclick="PreviousPage" disabled="@(this.currentPage <= 1 || this.isLoading)">
            <span>‹ Previous</span>
        </button>
        
        <div class="pagination-info mx-2">
            <span class="current-page">Page @this.currentPage of @this.TotalPages</span>
            <span class="total-items">(@this.totalPublications total publications)</span>
        </div>
        
        <button class="btn btn-theme" @onclick="NextPage" disabled="@(this.currentPage >= this.TotalPages || this.isLoading)">
            <span>Next ›</span>
        </button>

        <button class="btn btn-theme ms-1" @onclick="LastPage" disabled="@(this.currentPage >= this.TotalPages || this.isLoading)" 
                title="Last Page" style="padding: 0 10px; min-width: 40px;">
            <span>&raquo;</span>
        </button>
    </div>
}