@page "/publications"

<h3>Publications</h3>

<div class="row mb-3">
    <div class="col-md-6 offset-md-3">
        <div class="input-group dropdown">
            <span class="input-group-text bg-white border-end-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                </svg>
            </span>

            <input type="text"
                   class="form-control border-start-0"
                   placeholder="Search title / author / genre..."
                   @bind="SearchTerm"
                   @bind:event="oninput"
                   @onfocus="() => this.showSearchResults = true"
                   @onblur="OnSearchBlur"
                   aria-expanded="@(this.showSearchResults ? "true" : "false")"
                   autocomplete="off" />

            <ul class="dropdown-menu w-100 shadow @(this.showSearchResults && !string.IsNullOrEmpty(this.SearchTerm) ? "show" : "")"
                style="max-height: 300px; overflow-y: auto;">

                @if (this.isSearching)
                {
                    <li><span class="dropdown-item-text text-muted text-center">Searching...</span></li>
                }
                else if (this.searchResults.Any())
                {
                    @foreach (var result in this.searchResults)
                    {
                        <li>
                            <button class="dropdown-item" type="button" @onmousedown="() => SelectSearchResult(result.ImageId)">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 text-truncate" style="max-width: 70%;">@result.Title</h6>
                                    <small class="text-muted">@result.Year</small>
                                </div>
                                <small class="text-muted d-block text-truncate">@result.Author</small>
                            </button>
                        </li>
                    }
                }
                else
                {
                    <li><span class="dropdown-item-text text-muted text-center">No books found.</span></li>
                }
            </ul>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 col-sm-6 mb-2">
        <label class="form-label fw-bold">Availability</label>
        <select class="form-select" @bind=(this.filterAvailability) @bind:after="OnFilterChanged">
            <option value=@(PublicationParams.GetAvailabilityText(PublicationParams.PublicationAvailability.All))>All</option>
            <option value=@(PublicationParams.GetAvailabilityText(PublicationParams.PublicationAvailability.AvailableOnly))>Available</option>
        </select>
    </div>
    <div class="col-md-4 col-sm-6 mb-2">
        <label class="form-label fw-bold">Sort by</label>
        <select class="form-select" @bind=(this.filterSort) @bind:after="OnFilterChanged">
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.None))>None</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByTitleAsc))>Name (A-Z)</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByTitleDesc))>Name (Z-A)</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByPublicationYearAsc))>Year (Oldest first)</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByPublicationYearDesc))>Year (Newest first)</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByGreatestPopularity))>Most Popular</option>
        </select>
    </div>
</div>

@if (this.isLoading)
{
    <p><em>Loading publications...</em></p>
}
else if (!string.IsNullOrEmpty(this.error))
{
    <div class="alert alert-danger">@error</div>
}
else if (this.publications is null || this.publications.Count == 0)
{
    <p>No publications found.</p>
}
else
{
    @if (this.isLoadingImages)
    {
        <div class="alert alert-info">Loading...</div>
    }

    <div class="row">
        @for (int idx = 0; idx < this.publications.Count; idx++)
        {
            var pub = this.publications[idx];
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="publication-image-container">
                        @{
                            var imageUrl = GetImageDataUrl(pub?.Image);
                        }
                        @if (!string.IsNullOrEmpty(imageUrl))
                        {
                            <img src="@imageUrl" class="publication-image" alt="@(pub?.Title ?? "Unknown title")" />
                        }
                        else if (this.isLoadingImages && idx >= this.imagesLoaded) // idx < (imgsLoaded) and imageUrl is empty => img does not exist
                        {
                            <div class="publication-image-placeholder">
                                <span>Loading...</span>
                            </div>
                        }
                        else
                        {
                            <div class="publication-image-placeholder">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
                                    <path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2zM14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1zM2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1h-10z"/>
                                </svg>
                                <span class="mt-2">No image</span>
                            </div>
                        }
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@(pub?.Title ?? "Unknown title")</h5>
                        <p class="card-text flex-grow-1">
                            <strong>Author:</strong> @(pub?.Author ?? "Unknown author")<br/>
                            <strong>Publisher:</strong> @(pub?.Publication ?? "Unknown publication")<br/>
                            <strong>Year:</strong> @(pub?.Year.ToString() ?? "Unknown publication year")
                        </p>
                    </div>
                </div>
            </div>
        }
    </div>

    var totalPages = (int)Math.Ceiling(this.totalPublications / (1.0 * Math.Max(PageSize, 1) ));
    
    <div class="pagination-container">
        <button class="btn btn-primary" @onclick="PreviousPage" disabled="@(this.currentPage <= 1 || this.isLoading)">
            <span>‹ Previous</span>
        </button>
        <div class="pagination-info">
            <span class="current-page">Page @this.currentPage of @totalPages</span>
                <span class="total-items">(@this.totalPublications total publications)</span>
        </div>
        <button class="btn btn-primary" @onclick="NextPage" disabled="@(this.currentPage >= totalPages || this.isLoading)">
            <span>Next ›</span>
        </button>
    </div>
}