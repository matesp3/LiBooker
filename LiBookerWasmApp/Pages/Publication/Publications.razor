@page "/publications"

<h3>Publications</h3>

<div class="row mb-3">
    <div class="col-md-6 offset-md-3">
        <!-- Wrapper with position-relative to anchor the dropdown correctly below the input group -->
        <div class="position-relative">
            
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                    </svg>
                </span>

                <input type="text"
                       class="@($"form-control border-start-0 {(string.IsNullOrEmpty(this.SearchTerm) ? "" : "border-end-0")}")"
                       placeholder="Search title / author / genre..."
                       @bind="SearchTerm"
                       @bind:event="oninput"
                       @onfocus="() => this.showSearchResults = true"
                       @onblur="OnSearchBlur"
                       aria-expanded="@(this.showSearchResults ? "true" : "false")"
                       autocomplete="off" />
                
                <!-- Clear Button (X) - Only visible when text is present -->
                @if (!string.IsNullOrEmpty(this.SearchTerm))
                {
                    <button class="btn bg-white border border-start-0" type="button" @onclick="ClearSearch" title="Clear search">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="upperText16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 1 1 .708.708L8.707 8l5.147 5.146a.5.5 0 1 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 1 1-.708-.708L7.293 8 2.146 2.854Z"/>
                        </svg>
                    </button>
                }
            </div>

            <ul class="dropdown-menu w-100 shadow @(this.showSearchResults && !string.IsNullOrEmpty(this.SearchTerm) ? "show" : "")"
                style="max-height: 300px; overflow-y: auto;">

                @if (this.isSearching)
                {
                    <li><span class="dropdown-item-text text-muted text-center">Searching...</span></li>
                }
                else if (this.searchResults.Any())
                {
                    // 1. books section
                    var books = this.searchResults.OfType<BookMatch>().ToList();
                    if (books.Any())
                    {
                        <li><h6 class="dropdown-header font-weight-bold text-uppercase mt-2">Books</h6></li>
                        @foreach (var book in books)
                        {
                            <li>
                                <button class="dropdown-item search-item d-flex flex-column justify-content-center py-2" 
                                        type="button" 
                                        @onmousedown="() => SelectSearchResultItem(book)">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <h6 class="mb-0 text-truncate" style="max-width: 80%;">@book.Title</h6>
                                    </div>
                                    <small class="text-muted d-block text-truncate w-100 mt-1">
                                        @(string.IsNullOrWhiteSpace(book.Authors) ? "\u00A0" : book.Authors)
                                    </small>
                                </button>
                            </li>
                        }
                        @if(this.searchResults.OfType<AuthorMatch>().Any() || this.searchResults.OfType<GenreMatch>().Any()) 
                        { 
                            <li><hr class="dropdown-divider"></li> 
                        }
                    }

                    // 2. authors section
                    var authors = this.searchResults.OfType<AuthorMatch>().ToList();
                    if (authors.Any())
                    {
                        <li><h6 class="dropdown-header font-weight-bold text-uppercase mt-2">Authors</h6></li>
                        @foreach (var author in authors)
                        {
                            <li>
                                <button class="dropdown-item search-item d-flex flex-column justify-content-center py-2" 
                                        type="button" 
                                        @onmousedown="() => SelectSearchResultItem(author)">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <h6 class="mb-0 text-truncate">@author.FullName</h6>
                                    </div>
                                    <!-- Placeholder for ensuring equal height-->
                                    <small class="text-muted d-block mt-1">&nbsp;</small>
                                </button>
                            </li>
                        }
                        if(this.searchResults.OfType<GenreMatch>().Any()) 
                        { 
                            <li><hr class="dropdown-divider"></li> 
                        }
                    }

                    // genres section
                    var genres = this.searchResults.OfType<GenreMatch>().ToList();
                    if (genres.Any())
                    {
                        <li><h6 class="dropdown-header font-weight-bold text-uppercase mt-2">Genres</h6></li>
                        @foreach (var genre in genres)
                        {
                            <li>
                                <button class="dropdown-item search-item d-flex flex-column justify-content-center py-2" 
                                        type="button" 
                                        @onmousedown="() => SelectSearchResultItem(genre)">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <h6 class="mb-0 text-truncate">@genre.Name</h6>
                                    </div>
                                    <small class="text-muted d-block mt-1">&nbsp;</small>
                                </button>
                            </li>
                        }
                    }
                }
                else
                {
                    <li><span class="dropdown-item-text text-muted text-center">No books found.</span></li>
                }
            </ul>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 col-sm-6 mb-2">
        <label class="form-label fw-bold">Availability</label>
        <select class="form-select" @bind=(this.filterAvailability) @bind:after="OnFilterChanged">
            <option value=@(PublicationParams.GetAvailabilityText(PublicationParams.PublicationAvailability.All))>All</option>
            <option value=@(PublicationParams.GetAvailabilityText(PublicationParams.PublicationAvailability.AvailableOnly))>Available</option>
        </select>
    </div>
    <div class="col-md-4 col-sm-6 mb-2">
        <label class="form-label fw-bold">Sort by</label>
        <select class="form-select" @bind=(this.filterSort) @bind:after="OnFilterChanged">
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.None))>None</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByTitleAsc))>Name (A-Z)</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByTitleDesc))>Name (Z-A)</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByPublicationYearAsc))>Year (Oldest first)</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByPublicationYearDesc))>Year (Newest first)</option>
            <option value=@(PublicationParams.GetSortingText(PublicationParams.PublicationsSorting.ByGreatestPopularity))>Most Popular</option>
        </select>
    </div>
</div>

@if (this.isLoading)
{
    <p><em>Loading publications...</em></p>
}
else if (!string.IsNullOrEmpty(this.error))
{
    <div class="alert alert-danger">@error</div>
}
else if (this.publications is null || this.publications.Count == 0)
{
    <p>No publications found.</p>
}
else
{
    @if (this.isLoadingImages)
    {
        <div class="alert alert-info">Loading...</div>
    }

    <div class="row">
        @for (int idx = 0; idx < this.publications.Count; idx++)
        {
            var pub = this.publications[idx];
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="publication-image-container">
                        @{
                            var imageUrl = GetImageDataUrl(pub?.Image);
                        }
                        @if (!string.IsNullOrEmpty(imageUrl))
                        {
                            <img src="@imageUrl" class="publication-image" alt="@(pub?.Title ?? "Unknown title")" />
                        }
                        else if (this.isLoadingImages && idx >= this.imagesLoaded) // idx < (imgsLoaded) and imageUrl is empty => img does not exist
                        {
                            <div class="publication-image-placeholder">
                                <span>Loading...</span>
                            </div>
                        }
                        else
                        {
                            <div class="publication-image-placeholder">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
                                    <path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2zM14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1zM2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1h-10z"/>
                                </svg>
                                <span class="mt-2">No image</span>
                            </div>
                        }
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@(pub?.Title ?? "Unknown title")</h5>
                        <p class="card-text flex-grow-1">
                            <strong>Author:</strong> @(pub?.Author ?? "Unknown author")<br/>
                            <strong>Publisher:</strong> @(pub?.Publication ?? "Unknown publication")<br/>
                            <strong>Year:</strong> @(pub?.Year.ToString() ?? "Unknown publication year")
                        </p>
                    </div>
                </div>
            </div>
        }
    </div>

    var totalPages = (int)Math.Ceiling(this.totalPublications / (1.0 * Math.Max(PageSize, 1) ));
    
    <div class="pagination-container">
        <button class="btn btn-primary" @onclick="PreviousPage" disabled="@(this.currentPage <= 1 || this.isLoading)">
            <span>‹ Previous</span>
        </button>
        <div class="pagination-info">
            <span class="current-page">Page @this.currentPage of @totalPages</span>
                <span class="total-items">(@this.totalPublications total publications)</span>
        </div>
        <button class="btn btn-primary" @onclick="NextPage" disabled="@(this.currentPage >= totalPages || this.isLoading)">
            <span>Next ›</span>
        </button>
    </div>
}