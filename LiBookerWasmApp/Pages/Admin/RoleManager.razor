@page "/admin/roles"
@using LiBooker.Shared.DTOs.Admin
@using LiBookerWasmApp.Pages.Admin.Components
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

<h3 class="page-title">Roles Administration</h3>
<hr class="separator" />

<div class="search-container">
    <label class="search-label">find account:</label>
    <div class="search-wrapper">
        <UserSearchInput OnSearchConfirmed="OnSearchRequested" Placeholder="type e-mail" />
    </div>
</div>

<hr class="separator-light" />

@if (error != null)
{
    <div class="alert alert-danger">@error</div>
}

<div class="results-area">
    <h5 class="results-title">Found matches:</h5>

    @if (isLoading)
    {
        <div class="results-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="loading-text">Loading users…</div>
        </div>
    }
    else if (allLoadedUsers.Count == 0 && !string.IsNullOrEmpty(currentSearchTerm))
    {
        <p class="text-muted">No users found matching "@currentSearchTerm".</p>
    }
    else if (allLoadedUsers.Count > 0)
    {
        <table class="table user-table">
            <thead>
                <tr>
                    <th>email</th>
                    <th>user's Full name</th>
                    <th>registered</th>
                    <th>roles</th>
                    <th>manage roles</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in pagedUsers)
                {
                    <tr>
                        <td class="email-col">@user.Email</td>
                        <td>@user.FullName</td>
                        <td>@user.RegisteredAt.ToShortDateString()</td>
                        <td class="roles-col">@string.Join(", ", user.Roles)</td>
                        <td>
                            <button class="btn btn-edit" @onclick="() => OpenEditModal(user)">
                                edit
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @if (TotalPages > 1)
        {
            <div class="pagination-controls">
                <button class="btn btn-sm btn-outline-secondary" disabled="@(currentPage == 1)" @onclick="PrevPage">prev</button>
                <span class="page-info">@currentPage of @TotalPages</span>
                <button class="btn btn-sm btn-outline-secondary" disabled="@(currentPage == TotalPages)" @onclick="NextPage">next</button>
            </div>
        }
    }
</div>

<!-- Modal Dialog -->
@if (isModalOpen && selectedUserForEdit != null)
{
    <div class="modal-backdrop-custom" @onclick="CloseModalOnBackdrop">
        <div class="modal-window" @onclick:stopPropagation>
            <div class="modal-header-custom">
                <h5>Edit Roles for: <span class="modal-email">@selectedUserForEdit.Email</span></h5>
                <button class="btn-close-custom" title="Close" @onclick="CloseModal">✕</button>
            </div>

            <div class="modal-body-custom roles-modal-grid">
                <!-- Left: available -->
                <div class="role-box">
                    <div class="box-header">unassigned</div>
                    <div class="box-content scrollable">
                        @foreach (var role in editAvailableRoles)
                        {
                            var isSel = selectedAvailable.Contains(role);
                            <div class="role-row @(isSel ? "selected" : "")"
                                 @onclick="() => ToggleSelectAvailable(role)"
                                 @ondblclick="() => MoveSingleAvailableToAssigned(role)">
                                @role
                            </div>
                        }
                    </div>
                </div>

                <!-- Center: controls -->
                <div class="transfer-controls">
                    <button class="btn arrow-btn add-btn" @onclick="MoveSelectedToAssigned" disabled="@(selectedAvailable.Count == 0)">
                        @(isSaving ? "…" : "≫")
                    </button>
                    <button class="btn arrow-btn remove-btn" @onclick="MoveSelectedToAvailable" disabled="@(selectedAssigned.Count == 0)">
                        @(isSaving ? "…" : "≪")
                    </button>
                </div>

                <!-- Right: assigned -->
                <div class="role-box">
                    <div class="box-header">assigned</div>
                    <div class="box-content scrollable">
                        @foreach (var role in editAssignedRoles)
                        {
                            var isSel = selectedAssigned.Contains(role);
                            <div class="role-row @(isSel ? "selected" : "")"
                                 @onclick="() => ToggleSelectAssigned(role)"
                                 @ondblclick="() => MoveSingleAssignedToAvailable(role)">
                                @role
                            </div>
                        }
                    </div>
                </div>
            </div>

            @* Inline error shown in modal *@
            @if (!string.IsNullOrEmpty(modalError))
            {
                <div class="modal-inline-error alert alert-danger" role="alert">
                    <span class="modal-error-text">@modalError</span>
                    <button class="modal-error-close" @onclick="DismissModalError" title="Dismiss error" aria-label="Dismiss error">✕</button>
                </div>
            }

            <div class="modal-footer-custom">
                <button class="btn btn-cancel" @onclick="CloseModal" disabled="@isSaving">Cancel</button>
                <button class="btn btn-save" @onclick="SaveRolesAsync" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="visually-hidden">Saving...</span>
                    }
                    else
                    {
                        <span>Save</span>
                    }
                </button>
            </div>
        </div>
    </div>
}