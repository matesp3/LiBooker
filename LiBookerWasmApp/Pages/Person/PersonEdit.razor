@page "/person/details/edit"
@using System.ComponentModel.DataAnnotations
@using LiBooker.Shared.DTOs
@inject PersonClient PersonClient
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@implements IDisposable

<div class="profile-container fade-in">
    @if (IsLoading)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading profile for editing...</p>
        </div>
    }
    else if (this.editModel == null)
    {
         <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading">Error</h4>
            <p>Could not load user data.</p>
        </div>
    }
    else
    {
        <div class="profile-card">
            <div class="profile-header">
                <div class="avatar-circle">
                    <i class="bi bi-pencil-fill" style="font-size: 2rem;"></i>
                </div>
                <h2 class="profile-name">Edit Profile</h2>
                <span class="profile-badge">Update your details</span>
            </div>

            <div class="profile-body">
                <!-- ERROR BADGE / ALERT -->
                @if (!string.IsNullOrEmpty(this.errorMessage))
                {
                    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16">
                            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg>
                        <div>
                            @this.errorMessage
                        </div>
                    </div>
                }

                <EditForm Model="@this.editModel" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="profile-section">
                        <h5 class="section-title">Personal Information</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">First Name</label>
                                <InputText class="form-control" @bind-Value="this.editModel.FirstName" />
                                <ValidationMessage For="@(() => this.editModel.FirstName)" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name</label>
                                <InputText class="form-control" @bind-Value="this.editModel.LastName" />
                                <ValidationMessage For="@(() => this.editModel.LastName)" />
                            </div>
                             <div class="col-md-6">
                                <label class="form-label">Birth Date</label>
                                <InputDate class="form-control" @bind-Value="this.editModel.BirthDate" />
                                <ValidationMessage For="@(() => this.editModel.BirthDate)" />
                            </div>
                             <div class="col-md-6">
                                <label class="form-label">Gender</label>
                                <InputSelect class="form-select" @bind-Value="this.editModel.Gender">
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => this.editModel.Gender)" />
                            </div>
                        </div>
                    </div>

                    <div class="separator"></div>

                    <div class="profile-section">
                        <h5 class="section-title">Contact Details</h5>
                         <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Email</label>
                                <InputText class="form-control" @bind-Value="this.editModel.Email" />
                                <ValidationMessage For="@(() => this.editModel.Email)" />
                            </div>
                            <div class="col-12">
                                <label class="form-label">Phone</label>
                                <InputText class="form-control" @bind-Value="this.editModel.Phone" placeholder="+421..." />
                                <ValidationMessage For="@(() => this.editModel.Phone)" />
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons mt-4">
                        <button type="button" class="btn btn-secondary me-2" @onclick="CancelEdit" disabled="@isSaving">
                            Cancel
                        </button>
                        
                        <button type="submit" class="btn btn-primary btn-save" disabled="@this.isSaving">
                            @if (this.isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>Save Changes</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    private bool IsLoading = true;
    private bool isSaving = false;
    private int personId;
    private string? errorMessage;
    private PersonEditModel? editModel;
    private CancellationTokenSource? cts;

    protected override async Task OnInitializedAsync()
    {
        this.cts = new CancellationTokenSource();
        var authState = await this.AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var personIdClaim = user.FindFirst("PersonId");
            if (personIdClaim != null && int.TryParse(personIdClaim.Value, out int pid))
            {
                personId = pid;
                var response = await PersonClient.GetPersonByIdAsync(personId, this.cts.Token);
                if (response.IsSuccess && response.Data != null)
                {
                    // DTO mapping to Mutable Model
                    var p = response.Data;
                    this.editModel = new PersonEditModel
                    {
                        FirstName = p.FirstName,
                        LastName = p.LastName,
                        Email = p.Email,
                        Phone = p.Phone,
                        BirthDate = p.BirthDate,
                        Gender = p.Gender.ToString()
                    };
                }
            }
        }
        this.IsLoading = false;
    }

    private async Task HandleValidSubmit()
    {
        if (this.editModel == null) return;
        
        this.isSaving = true; // spinner on
        // StateHasChanged();

        try 
        {
            var updateDto = new PersonUpdate
            {
                FirstName = editModel.FirstName,
                LastName = editModel.LastName,
                Email = editModel.Email,
                Phone = editModel.Phone,
                BirthDate = editModel.BirthDate,
                Gender = editModel.Gender[0]
            };

            var result = await PersonClient.UpdatePersonAsync(personId, updateDto);
            
            if (result.IsSuccess) 
            {
                // UI update - Greeting the user
                if (this.AuthStateProvider is LiBookerWasmApp.Services.Auth.CustomAuthStateProvider customAuthProvider)
                {
                    await customAuthProvider.RefreshUserAsync();
                }

                this.Navigation.NavigateTo("/person/details?updateOk=true");
            }
            else
            {
                this.errorMessage = $"Failed to update the profile. ({result.Error})";
            }
        }
        finally 
        {
            this.isSaving = false; // spinner off
        }
    }

    private void CancelEdit()
    {
        this.Navigation.NavigateTo("/person/details");
    }

    public void Dispose()
    {
        this.cts?.Cancel();
        // this.cts?.Dispose();
    }

    // Mutable model for the form
    public class PersonEditModel
    {
        [Required]
        public string FirstName { get; set; } = "";
        
        [Required]
        public string LastName { get; set; } = "";

        [Required] 
        [EmailAddress]
        public string Email { get; set; } = "";
        
        public string? Phone { get; set; }
        
        public DateTime BirthDate { get; set; }
        
        public string Gender { get; set; } = "M"; // String specifically for InputSelect compatibility
    }
}
